name: Community Backend CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Build JAR
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test --no-daemon
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: build/libs/*.jar

  deploy:
    needs: build
    runs-on: [self-hosted, linux, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: build/libs
      - name: Build Image and Deploy
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          PUBLIC_BASE_URL: ${{ secrets.PUBLIC_BASE_URL }}
        run: |
          # 1. 최신 이미지 빌드
          docker build -t ghcr.io/cozyrim/community-backend:latest .
          
          # 2. Nginx 설정 파일 강제 동기화 및 컨테이너 재시작
          # --force-recreate를 사용하여 변경된 nginx.conf를 확실히 적용합니다.
          docker compose -p community -f docker-compose.prod.yml up -d --force-recreate backend mysql nginx
          
          # 3. 정리
          docker system prune -f
