name: Community Backend CI/CD

on:
  push:
    branches: [ main ]

jobs:
  # 1단계: 빌드는 성능 좋은 GitHub 서버에서 수행 (매우 빠름)
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Build JAR
        run: |
          chmod +x ./gradlew
          ./gradlew bootJar -x test --no-daemon
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: build/libs/*.jar

  # 2단계: 배포만 라즈베리파이에서 수행 (가벼운 작업)
  deploy:
    needs: build
    runs-on: [self-hosted, linux, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: build/libs
      - name: Build Image and Deploy
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        run: |
          docker build -t ghcr.io/cozyrim/community-backend:latest .
          docker compose -p community -f docker-compose.prod.yml up -d backend mysql nginx
          docker system prune -f
